<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7726590371480649"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/styles/header.css" type="text/css">
  <link rel="icon" href="/assets/images/foxycake.png">
  <title>Foxy | Loja</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-E3J7N4BP8L"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-E3J7N4BP8L');
  </script>
  <link rel="stylesheet" href="/styles/dashboard.css" type="text/css">
  <link rel="stylesheet" href="/styles/loading.css" type="text/css">
</head>

<body>
  <div id="loadingOverlay" class="loading-overlay">
    <%- include('../../global/loading') %>
  </div>

  <%- include('../sidebar') %>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7726590371480649"
      crossorigin="anonymous"></script>
    <ins id="adBanner" class="adsbygoogle" style="display:inline-block;width:160px;height:600px"
      data-ad-client="ca-pub-7726590371480649" data-ad-slot="4619028248"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>

    <main id="content" class="hidden"></main>

    <div id="popup" class="popup hidden">
      <div class="popup-content">
        <span class="close" onclick="hidePopup()">&times;</span>
        <h2 id="bg-title"></h2>
        <img id="popup-img" src="" alt="Background Image">
        <h3 id="bg-description"></h3>
        <h3>VocÃª possui <strong style="color: #e7385d;" id="user-cakes"></strong> Cakes</h3>
        <form id="purchaseForm" method="POST">
          <input type="hidden" name="backgroundId" id="backgroundId">
          <button class="server__button" id="save" type="submit">Comprar</button>
        </form>
      </div>
    </div>

    <script>
      window.addEventListener('load', function () {
        fetch('/br/store/data')
          .then(response => response.json())
          .then(data => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
            <div class="itens">
              ${data.storeContent.decorations.reverse().map(decoration => {
              if (decoration.cakes === 0 || decoration.inactive) {
                return '';
              }

              const decorationStr = JSON.stringify(decoration).replace(/"/g, '&quot;');
              const userStr = JSON.stringify(data.user).replace(/"/g, '&quot;');
              const userDataStr = JSON.stringify(data.userData).replace(/"/g, '&quot;');

              return `
                  <div class="item ${data.userData.userProfile.decorationList.includes(decoration.id) ? 'disabled' : ''}"
                    onclick="showPopup(${decorationStr}, ${userStr}, ${userDataStr})">
                    <div class="item__icon">
                      <img class="background" 
                        src="https://orchid.cakeyfox.live/assets/masks/${decoration.filename}" 
                        onerror="this.src='https://cakey.foxybot.win/assets/masks/${decoration.filename}'" 
                        alt="${decoration.name}">
                    </div>
                    <div class="item_info">
                      <h1 class="item-name">${decoration.name}</h1>
                      ${data.userData.userProfile.decorationList.includes(decoration.id) ? `
                        <span class="purchased">ðŸ’– JÃ¡ comprado</span>
                      ` : `
                        <span class="cakes">${decoration.cakes.toLocaleString("pt-BR")} Cakes</span>
                      `}
                    </div>
                  </div>
                `;
            }).join('')}
            </div>
          `;

            document.getElementById('user-cakes').innerText = data.userData.userCakes.balance.toLocaleString("pt-BR");
          })
          .catch(error => {
            console.error('Erro ao buscar os dados:', error);
            document.getElementById('loadingOverlay').innerText = 'Falha ao carregar o conteÃºdo. Tente novamente mais tarde.';
          });
      });

      function showPopup(decoration, user, userData) {
        document.getElementById('backgroundId').value = decoration.id;
        document.getElementById('popup').classList.add('visible');
        document.getElementById('popup').classList.remove('hidden');
        document.getElementById('bg-title').innerText = decoration.name;
        document.getElementById('bg-description').innerText = decoration.description;
        document.getElementById('popup-img').src = "https://orchid.cakeyfox.live/assets/masks/" + decoration.filename;

        document.getElementById('popup-img').onerror = function () {
          this.src = "https://cakey.foxybot.win/assets/masks/" + decoration.filename;
        };

        const userCakes = parseInt(document.getElementById('user-cakes').innerText.replace(/\D/g, ''));
        const saveButton = document.getElementById('save');
        if (userData.userProfile.decorationList.includes(decoration.id)) {
          saveButton.disabled = true;
          saveButton.classList.add('disabled');
          saveButton.innerText = 'Comprado';
        } else {
          saveButton.disabled = userCakes < decoration.cakes;
          saveButton.classList.toggle('disabled', saveButton.disabled);
          saveButton.innerText = saveButton.disabled ? 'IndisponÃ­vel' : 'Comprar';
        }
      }

      function hidePopup() {
        const popup = document.getElementById('popup');
        popup.classList.remove('visible');

        setTimeout(() => {
          popup.classList.add('hidden');
        }, 300);
      }

      document.getElementById('purchaseForm').addEventListener('submit', function (event) {
        const backgroundId = document.getElementById('backgroundId').value;
        this.action = "/br/store/confirm/" + backgroundId;
      });
    </script>

</body>

</html>